/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var N=Object.defineProperty;var J=Object.getOwnPropertyDescriptor;var Q=Object.getOwnPropertyNames;var Y=Object.prototype.hasOwnProperty;var Z=(i,n)=>{for(var s in n)N(i,s,{get:n[s],enumerable:!0})},ss=(i,n,s,a)=>{if(n&&typeof n=="object"||typeof n=="function")for(let t of Q(n))!Y.call(i,t)&&t!==s&&N(i,t,{get:()=>n[t],enumerable:!(a=J(n,t))||a.enumerable});return i};var es=i=>ss(N({},"__esModule",{value:!0}),i);var cs={};Z(cs,{default:()=>$});module.exports=es(cs);var A=require("obsidian");var D={asanaAccessToken:"",workspaceGid:"",workspaceName:"",syncedProjects:[],syncIntervalMinutes:5,syncFolder:"Asana",showDueDates:!0,showAssignees:!0,showCompletedTasks:!1,syncMyTasks:!1,userGid:""};var l=require("obsidian");var W=require("obsidian"),ts="https://app.asana.com/api/1.0";async function v(i,n,s="GET",a){let t={url:`${ts}${n}`,method:s,headers:{Authorization:`Bearer ${i}`,"Content-Type":"application/json"}};a&&(t.body=JSON.stringify({data:a}));let r=await(0,W.requestUrl)(t);if(r.status<200||r.status>=300)throw new Error(`Asana API error: ${r.status} ${JSON.stringify(r.json)}`);return r.json}async function R(i){return(await v(i,"/workspaces")).data}async function V(i,n,s=!1){return(await v(i,`/workspaces/${n}/projects?limit=100${s?"":"&archived=false"}`)).data}async function x(i){return(await v(i,"/users/me")).data}async function O(i,n,s){return(await v(i,`/users/${n}/user_task_list?workspace=${s}`)).data.gid}async function G(i,n){var r,d;let s="gid,name,completed,due_on,assignee,assignee.name,permalink_url,notes,memberships.project,memberships.project.name,memberships.section,memberships.section.name",a=[],t=null;do{let e=t?`&offset=${t}`:"",o=await v(i,`/projects/${n}/tasks?opt_fields=${s}&limit=100${e}`);a.push(...o.data),t=(d=(r=o.next_page)==null?void 0:r.offset)!=null?d:null}while(t);return a}async function _(i,n){var r,d;let s="gid,name,completed,due_on,assignee,assignee.name,permalink_url,notes,memberships.project,memberships.project.name,memberships.section,memberships.section.name",a=[],t=null;do{let e=t?`&offset=${t}`:"",o=await v(i,`/user_task_lists/${n}/tasks?opt_fields=${s}&limit=100${e}`);a.push(...o.data),t=(d=(r=o.next_page)==null?void 0:r.offset)!=null?d:null}while(t);return a}async function I(i,n,s){await v(i,`/tasks/${n}`,"PUT",{completed:s})}async function K(i){try{return await x(i),!0}catch(n){return!1}}var F=class extends l.FuzzySuggestModal{constructor(s,a,t){super(s);this.resolved=!1;this.items=a,this.resolve=t,this.setPlaceholder("Select a workspace")}getItems(){return this.items}getItemText(s){return s.name}onChooseItem(s){this.resolved||(this.resolved=!0,this.resolve(s))}onClose(){setTimeout(()=>{this.resolved||(this.resolved=!0,this.resolve(null))},100)}},E=class extends l.FuzzySuggestModal{constructor(s,a,t){super(s);this.resolved=!1;this.items=a,this.resolve=t,this.setPlaceholder("Select a project to sync")}getItems(){return this.items}getItemText(s){return s.isMyTasks?`\u{1F464} ${s.name}`:s.name}onChooseItem(s){this.resolved||(this.resolved=!0,this.resolve(s))}onClose(){setTimeout(()=>{this.resolved||(this.resolved=!0,this.resolve(null))},100)}},C=class extends l.PluginSettingTab{constructor(s,a){super(s,a);this.plugin=a}display(){let{containerEl:s}=this;s.empty();let a;new l.Setting(s).setName("Asana Personal Access Token").setDesc("Create one at https://app.asana.com/0/my-apps \u2192 Create new token").addText(e=>{e.setPlaceholder("Enter your access token"),e.inputEl.type="password",e.inputEl.style.width="300px",e.inputEl.value=this.plugin.settings.asanaAccessToken,a=e.inputEl}).addButton(e=>e.setButtonText("Save token").onClick(async()=>{let o=a.value.trim();this.plugin.settings.asanaAccessToken=o,await this.plugin.saveSettings(),new l.Notice(o?"Token saved":"Token cleared")})),new l.Setting(s).setName("Validate token").setDesc("Test your Asana connection").addButton(e=>e.setButtonText("Test connection").onClick(async()=>{let o=a.value.trim();o&&o!==this.plugin.settings.asanaAccessToken&&(this.plugin.settings.asanaAccessToken=o,await this.plugin.saveSettings());let c=this.plugin.settings.asanaAccessToken;if(!c){new l.Notice("Please enter and save an access token first");return}e.setButtonText("Testing..."),e.setDisabled(!0);try{if(await K(c)){let p=await x(c);this.plugin.settings.userGid=p.gid,await this.plugin.saveSettings(),new l.Notice(`Connected as ${p.name} (${p.email})`)}else new l.Notice("Invalid token - please check and try again")}catch(u){new l.Notice("Connection failed - check token and try again")}e.setButtonText("Test connection"),e.setDisabled(!1)})),new l.Setting(s).setName("Workspace").setDesc(this.plugin.settings.workspaceName?`Current: ${this.plugin.settings.workspaceName}`:"Select your Asana workspace").addButton(e=>e.setButtonText("Select workspace").onClick(async()=>{let o=this.plugin.settings.asanaAccessToken;if(!o){new l.Notice("Please enter an access token first");return}try{let c=await R(o);if(c.length===0){new l.Notice("No workspaces found");return}let u=await new Promise(p=>{new F(this.app,c,p).open()});u&&(this.plugin.settings.workspaceGid=u.gid,this.plugin.settings.workspaceName=u.name,await this.plugin.saveSettings(),this.display())}catch(c){new l.Notice("Failed to fetch workspaces")}})),new l.Setting(s).setName("Sync folder").setDesc("Folder where synced project notes will be created").addText(e=>e.setPlaceholder("Asana").setValue(this.plugin.settings.syncFolder).onChange(async o=>{this.plugin.settings.syncFolder=o||"Asana",await this.plugin.saveSettings()})),new l.Setting(s).setName("Sync interval (minutes)").setDesc("How often to auto-sync (0 to disable auto-sync)").addText(e=>e.setPlaceholder("5").setValue(String(this.plugin.settings.syncIntervalMinutes)).onChange(async o=>{let c=parseInt(o,10);!isNaN(c)&&c>=0&&(this.plugin.settings.syncIntervalMinutes=c,await this.plugin.saveSettings(),this.plugin.restartSyncInterval())})),new l.Setting(s).setName("Show due dates").setDesc("Display due dates on synced tasks").addToggle(e=>e.setValue(this.plugin.settings.showDueDates).onChange(async o=>{this.plugin.settings.showDueDates=o,await this.plugin.saveSettings()})),new l.Setting(s).setName("Show assignees").setDesc("Display assignee names on synced tasks").addToggle(e=>e.setValue(this.plugin.settings.showAssignees).onChange(async o=>{this.plugin.settings.showAssignees=o,await this.plugin.saveSettings()})),new l.Setting(s).setName("Show completed tasks").setDesc("Include completed tasks in synced notes. When off, completed tasks are hidden from notes but completion changes are still synced to Asana.").addToggle(e=>e.setValue(this.plugin.settings.showCompletedTasks).onChange(async o=>{this.plugin.settings.showCompletedTasks=o,await this.plugin.saveSettings()})),s.createEl("h3",{text:"Synced Projects"}),this.plugin.settings.syncedProjects.length===0&&s.createEl("p",{text:"No projects configured for sync. Click 'Add project' below.",cls:"setting-item-description"});for(let e=0;e<this.plugin.settings.syncedProjects.length;e++){let o=this.plugin.settings.syncedProjects[e];new l.Setting(s).setName(o.projectName).setDesc(`Note: ${o.notePath}`).addButton(c=>c.setButtonText("Remove").setWarning().onClick(async()=>{this.plugin.settings.syncedProjects.splice(e,1),await this.plugin.saveSettings(),this.display()}))}new l.Setting(s).addButton(e=>e.setButtonText("Add project").setCta().onClick(async()=>{await this.addProject()})),new l.Setting(s).addButton(e=>e.setButtonText("Add My Tasks").onClick(async()=>{await this.addMyTasks()})),s.createEl("hr");let t=s.createEl("div",{cls:"setting-item"});t.style.display="flex",t.style.alignItems="center",t.style.justifyContent="center",t.style.padding="1em 0";let d=t.createEl("a",{href:"https://buymeacoffee.com/jeanpatric"}).createEl("img");d.src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png",d.alt="Buy Me A Coffee",d.style.height="40px",d.style.width="auto"}async addProject(){let s=this.plugin.settings.asanaAccessToken,a=this.plugin.settings.workspaceGid;if(!s||!a){new l.Notice("Please configure your access token and select a workspace first");return}try{let t=await V(s,a);if(t.length===0){new l.Notice("No projects found in this workspace");return}let r=new Set(this.plugin.settings.syncedProjects.map(o=>o.projectGid)),d=t.filter(o=>!r.has(o.gid));if(d.length===0){new l.Notice("All projects are already being synced");return}let e=await new Promise(o=>{new E(this.app,d,o).open()});if(e){let o=e.name.replace(/[\\/:*?"<>|]/g,"-"),c=`${this.plugin.settings.syncFolder}/${o}.md`,u={projectGid:e.gid,projectName:e.name,notePath:c,isMyTasks:!1};this.plugin.settings.syncedProjects.push(u),await this.plugin.saveSettings(),this.display(),new l.Notice(`Added "${e.name}" for sync`)}}catch(t){new l.Notice("Failed to fetch projects"),console.error(t)}}async addMyTasks(){let s=this.plugin.settings.asanaAccessToken,a=this.plugin.settings.workspaceGid;if(!s||!a){new l.Notice("Please configure your access token and select a workspace first");return}if(this.plugin.settings.syncedProjects.some(t=>t.isMyTasks)){new l.Notice("My Tasks is already being synced");return}try{let t=this.plugin.settings.userGid;t||(t=(await x(s)).gid,this.plugin.settings.userGid=t);let r=await O(s,t,a),d=`${this.plugin.settings.syncFolder}/My Tasks.md`,e={projectGid:r,projectName:"My Tasks",notePath:d,isMyTasks:!0,userTaskListGid:r};this.plugin.settings.syncedProjects.push(e),await this.plugin.saveSettings(),this.display(),new l.Notice("Added My Tasks for sync")}catch(t){new l.Notice("Failed to add My Tasks"),console.error(t)}}};var S=require("obsidian");var ns=/^(\s*- \[)([ xX])(\] )(.+?)(?:\s*ðŸ“…\s*(\d{4}-\d{2}-\d{2}))?(?:\s*ðŸ‘¤\s*(.+?))?(?:\s*<!--\s*asana:(\w+)\s*-->)?\s*$/,as=/<!--\s*asana:(\w+)\s*-->/;function B(i,n){var a;let s=i.match(ns);return s?{line:i,lineNumber:n,completed:s[2]==="x"||s[2]==="X",name:s[4].trim(),asanaGid:s[7]||null,dueDate:s[5]||null,assignee:((a=s[6])==null?void 0:a.trim())||null}:null}function b(i,n,s){var r;let t=`${i.completed?"- [x]":"- [ ]"} ${i.name}`;return n&&i.due_on&&(t+=` \u{1F4C5} ${i.due_on}`),s&&((r=i.assignee)!=null&&r.name)&&(t+=` \u{1F464} ${i.assignee.name}`),t+=` <!-- asana:${i.gid} -->`,t}function is(i){let n=i.split(`
`),s=[],a=new Map,t="(Unsectioned)",r="",d="",e=!1,o=!1,c=!1;for(let u=0;u<n.length;u++){let p=n[u];if(u===0&&p==="---"){e=!0,r+=p+`
`;continue}if(e){r+=p+`
`,p==="---"&&(e=!1,o=!0);continue}if(o&&!c){if(p.startsWith("# ")){d=p,c=!0;continue}else if(p.trim()==="")continue}if(p.startsWith("## ")){t=p.replace(/^## /,"").trim(),a.has(t)||a.set(t,[]);continue}let m=B(p,u);m&&(s.push(m),a.has(t)||a.set(t,[]),a.get(t).push(m))}return{frontmatter:r,header:d,tasks:s,sections:a,rawLines:n}}function os(i,n,s,a,t,r,d=!0){var u;let e=[];e.push("---"),e.push(`asana_project_gid: "${n}"`),e.push(`asana_is_my_tasks: ${s}`),e.push(`asana_last_sync: "${new Date().toISOString()}"`),e.push("---"),e.push(""),e.push(`# ${i}`),e.push("");let o=d?a:a.filter(p=>!p.completed),c=new Map;for(let p of o){let m="(Unsectioned)";if(p.memberships&&p.memberships.length>0){let f=p.memberships.find(j=>{var P;return((P=j.project)==null?void 0:P.gid)===n});(u=f==null?void 0:f.section)!=null&&u.name&&(m=f.section.name)}c.has(m)||c.set(m,[]),c.get(m).push(p)}for(let[p,m]of c){p!=="(Unsectioned)"&&(e.push(`## ${p}`),e.push(""));for(let f of m)e.push(b(f,t,r));e.push("")}return e.join(`
`)}async function rs(i,n,s){var U;let a=n.asanaAccessToken,t={added:0,updated:0,completionChanges:0},r;s.isMyTasks&&s.userTaskListGid?r=await _(a,s.userTaskListGid):r=await G(a,s.projectGid);let d=new Map;for(let g of r)d.set(g.gid,g);let e=s.notePath,o=i.getAbstractFileByPath(e);if(!o||!(o instanceof S.TFile)){let g=os(s.projectName,s.projectGid,s.isMyTasks,r,n.showDueDates,n.showAssignees,n.showCompletedTasks),h=e.substring(0,e.lastIndexOf("/"));return h&&(i.getAbstractFileByPath(h)||await i.createFolder(h)),await i.create(e,g),t.added=r.length,t}let c=await i.read(o),u=is(c),p=new Map;for(let g of u.tasks)g.asanaGid&&p.set(g.asanaGid,g);for(let[g,h]of p){let y=d.get(g);if(y&&h.completed!==y.completed)try{await I(a,g,h.completed),t.completionChanges++}catch(k){console.error(`Failed to update task ${g} in Asana:`,k)}}s.isMyTasks&&s.userTaskListGid?r=await _(a,s.userTaskListGid):r=await G(a,s.projectGid),d.clear();for(let g of r)d.set(g.gid,g);let m=new Set,f=[],j=!1,P=!1,z="(Unsectioned)";for(let g=0;g<u.rawLines.length;g++){let h=u.rawLines[g];if(g===0&&h==="---"){j=!0,f.push(h);continue}if(j){h==="---"?(j=!1,P||(f.push(`asana_last_sync: "${new Date().toISOString()}"`),P=!0),f.push(h)):h.startsWith("asana_last_sync:")?(f.push(`asana_last_sync: "${new Date().toISOString()}"`),P=!0):f.push(h);continue}if(h.startsWith("## ")){z=h.replace(/^## /,"").trim(),f.push(h);continue}let y=h.match(as);if(y){let k=y[1],T=d.get(k);if(T){if(!n.showCompletedTasks&&T.completed){m.add(k);continue}f.push(b(T,n.showDueDates,n.showAssignees)),m.add(k),t.updated++}else f.push(h),m.add(k);continue}f.push(h)}let M=[];for(let g of r)if(!m.has(g.gid)){if(!n.showCompletedTasks&&g.completed)continue;M.push(g),t.added++}if(M.length>0){let g=new Map;for(let h of M){let y="(Unsectioned)";if(h.memberships&&h.memberships.length>0){let k=h.memberships.find(T=>{var w;return((w=T.project)==null?void 0:w.gid)===s.projectGid});(U=k==null?void 0:k.section)!=null&&U.name&&(y=k.section.name)}g.has(y)||g.set(y,[]),g.get(y).push(h)}for(let[h,y]of g){let k=`## ${h}`,T=f.findIndex(w=>w.trim()===k);if(T>=0&&h!=="(Unsectioned)"){let w=T+1;for(;w<f.length&&!f[w].startsWith("## ");)w++;let X=y.map(H=>b(H,n.showDueDates,n.showAssignees));f.splice(w,0,...X)}else if(h!=="(Unsectioned)"){f.push(""),f.push(k),f.push("");for(let w of y)f.push(b(w,n.showDueDates,n.showAssignees))}else for(let w of y)f.push(b(w,n.showDueDates,n.showAssignees))}}let L=f.join(`
`);return L!==c&&await i.modify(o,L),t}async function q(i,n){if(!n.asanaAccessToken){new S.Notice("Asana Sync: No access token configured");return}if(n.syncedProjects.length===0){new S.Notice("Asana Sync: No projects configured for sync");return}let s=0,a=0,t=0;for(let d of n.syncedProjects)try{let e=await rs(i,n,d);s+=e.added,a+=e.updated,t+=e.completionChanges}catch(e){console.error(`Failed to sync project ${d.projectName}:`,e),new S.Notice(`Asana Sync: Failed to sync "${d.projectName}"`)}let r=[];s>0&&r.push(`${s} added`),t>0&&r.push(`${t} completion changes`),r.length>0&&new S.Notice(`Asana Sync: ${r.join(", ")}`)}var $=class extends A.Plugin{constructor(){super(...arguments);this.settings=D;this.syncIntervalId=null;this.isSyncing=!1;this.fileModifiedBySync=new Set;this.lastKnownState=new Map}async onload(){await this.loadSettings(),this.addSettingTab(new C(this.app,this)),this.addCommand({id:"sync-asana",name:"Sync all projects",callback:()=>this.runSync()}),this.addRibbonIcon("refresh-cw","Sync Asana",()=>this.runSync()),this.registerEvent(this.app.vault.on("modify",s=>{s instanceof A.TFile&&s.extension==="md"&&this.handleFileModify(s)})),this.restartSyncInterval(),this.settings.asanaAccessToken&&this.settings.syncedProjects.length>0&&setTimeout(()=>this.runSync(),5e3)}onunload(){this.syncIntervalId!==null&&window.clearInterval(this.syncIntervalId)}async loadSettings(){this.settings=Object.assign({},D,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}restartSyncInterval(){if(this.syncIntervalId!==null&&(window.clearInterval(this.syncIntervalId),this.syncIntervalId=null),this.settings.syncIntervalMinutes>0){let s=this.settings.syncIntervalMinutes*60*1e3;this.syncIntervalId=window.setInterval(()=>this.runSync(),s),this.registerInterval(this.syncIntervalId)}}async runSync(){if(!this.isSyncing){this.isSyncing=!0;try{for(let s of this.settings.syncedProjects)this.fileModifiedBySync.add(s.notePath);await q(this.app.vault,this.settings)}catch(s){console.error("Asana Sync: sync failed",s),new A.Notice("Asana Sync: sync failed - check console for details")}finally{this.isSyncing=!1,setTimeout(()=>{this.fileModifiedBySync.clear()},2e3)}}}async handleFileModify(s){if(this.fileModifiedBySync.has(s.path)||this.isSyncing)return;let a=this.settings.syncedProjects.find(r=>r.notePath===s.path);if(!a)return;let t=`asana-sync-debounce-${s.path}`;this[t]&&window.clearTimeout(this[t]),this[t]=window.setTimeout(async()=>{delete this[t],await this.processCheckboxChanges(s,a)},1500)}async processCheckboxChanges(s,a){let t=this.settings.asanaAccessToken;if(!t)return;let d=(await this.app.vault.read(s)).split(`
`),e=new Map;for(let c=0;c<d.length;c++){let u=B(d[c],c);u!=null&&u.asanaGid&&e.set(u.asanaGid,u.completed)}let o=this.lastKnownState.get(s.path);if(o)for(let[c,u]of e){let p=o.get(c);if(p!==void 0&&p!==u)try{await I(t,c,u);let m=u?"completed":"reopened";new A.Notice(`Asana: Task ${m} in "${a.projectName}"`)}catch(m){console.error(`Failed to update task ${c}:`,m),new A.Notice("Asana Sync: Failed to update task in Asana")}}this.lastKnownState.set(s.path,e)}};
